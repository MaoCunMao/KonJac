<template>
  <div id="home">
    <ul>
      <!-- user:{{user}} -->
      <li @click="readingMode()">
        <svg t="1641892834528" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="14729" width="200" height="200">
          <path
            d="M928 161H699.2c-49.1 0-97.1 14.1-138.4 40.7L512 233l-48.8-31.3C422 175.1 373.9 161 324.8 161H96c-17.7 0-32 14.3-32 32v568c0 17.7 14.3 32 32 32h228.8c49.1 0 97.1 14.1 138.4 40.7l44.4 28.6c1.3 0.8 2.8 1.3 4.3 1.3s3-0.4 4.3-1.3l44.4-28.6C602 807.1 650.1 793 699.2 793H928c17.7 0 32-14.3 32-32V193c0-17.7-14.3-32-32-32zM324.8 721H136V233h188.8c35.4 0 69.8 10.1 99.5 29.2l48.8 31.3 6.9 4.5v462c-47.6-25.6-100.8-39-155.2-39z m563.2 0H699.2c-54.4 0-107.6 13.4-155.2 39V298l6.9-4.5 48.8-31.3c29.7-19.1 64.1-29.2 99.5-29.2H888v488z"
            p-id="14730"></path>
          <path
            d="M396.9 361H211.1c-3.9 0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9 0 7.1-3.4 7.1-7.5v-45c0.1-4.1-3.1-7.5-7-7.5z m223.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9 0 7.1-3.4 7.1-7.5v-45c0-4.1-3.2-7.5-7.1-7.5H627.1c-3.9 0-7.1 3.4-7.1 7.5zM396.9 501H211.1c-3.9 0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9 0 7.1-3.4 7.1-7.5v-45c0.1-4.1-3.1-7.5-7-7.5z m416 0H627.1c-3.9 0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9 0 7.1-3.4 7.1-7.5v-45c0.1-4.1-3.1-7.5-7-7.5z"
            p-id="14731"></path>
        </svg>
        阅读模式
      </li>

      <li @click="intoMode('cookingMode')">
        <svg t="1641892773474" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="13879" width="200" height="200">
          <path
            d="M888.021333 127.189333H136.021333c-39.637333 0-72.021333 32.426667-72.021333 72.021334v625.493333c0 39.594667 32.426667 71.978667 72.021333 71.978667h752c39.594667 0 71.978667-32.384 71.978667-71.978667V199.210667c0-39.594667-32.426667-72.021333-72.021333-72.021334z m0 697.301334l-0.128 0.128H136.192l-0.085333-0.128v-212.778667l185.6-189.824 217.301333 269.909333a35.968 35.968 0 0 0 47.189333 5.973334l160.512-108.458667 141.269334 66.474667v168.704z m0-259.285334l-118.101333-48.725333a35.882667 35.882667 0 0 0-42.026667-1.194667l-155.776 105.130667-222.122666-275.2a36.138667 36.138667 0 0 0-52.778667-1.408l-161.194667 164.906667V199.253333l0.085334-0.085333h751.701333l0.085333 0.085333 0.128 365.909334z m-190.037333-292.224a101.12 101.12 0 0 0-100.992 101.034667 101.12 101.12 0 0 0 100.992 100.992 101.12 101.12 0 0 0 101.034667-100.992 101.12 101.12 0 0 0-101.034667-101.034667z m0 130.005334a29.013333 29.013333 0 1 1 0.042667-58.026667 29.013333 29.013333 0 0 1 0 58.026667z"
            fill="#595959" p-id="13880"></path>
        </svg> 提取图片
      </li>
      <li @click="openOptions('local')">
        <a-icon type="desktop" />
        本地项目
      </li>
      <li @click="openOptions('online')">
        <a-icon type="cloud-server" />
        在线项目
      </li>
      <li @click="$router.push('/readConfig')">
        <svg t="1642601724214" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="30414" width="200" height="200">
          <path
            d="M544.033302 516.000776V96.000564c0-17.672051-14.478655-31.998984-32.150706-31.998984s-32.150706 14.326933-32.150707 31.998984v420.061624c-54.909072 14.251072-95.809105 64.333925-95.809105 123.935554 0 59.691941 40.82056 109.836206 96.090876 124.000579a32.298816 32.298816 0 0 0-0.281771 4.006195v159.99492c0 17.672051 14.478655 31.998984 32.150707 31.998984s32.150706-14.326933 32.150706-31.998984V768.004516a32.280754 32.280754 0 0 0-0.317894-3.941171c55.389526-14.088512 96.397933-64.301413 96.397932-124.058378 0.010837-59.691941-40.809723-109.832593-96.080038-124.004191z m13.221527 169.249989a64.00158 64.00158 0 1 1 18.744945-45.256635 63.578925 63.578925 0 0 1-18.744945 45.260247zM223.678606 196.003711a32.287979 32.287979 0 0 0 0.292607-4.002582V96.000564a31.970084 31.970084 0 1 0-63.940169 0V192.001129a32.371065 32.371065 0 0 0 0.180622 4.060381c-55.270316 14.160761-96.173962 64.301413-96.173961 124.000579s40.910871 109.818143 96.181186 123.996966a32.360228 32.360228 0 0 0-0.184234 3.937558V927.999436a31.970084 31.970084 0 1 0 63.940169 0V448.000226a32.287979 32.287979 0 0 0-0.278158-3.883372c55.385914-14.088512 96.350971-64.301413 96.350971-124.054765S279.071744 210.084998 223.678606 196.003711z m13.575545 169.315013A64.00158 64.00158 0 1 1 255.999097 320.062089a63.578925 63.578925 0 0 1-18.744946 45.256635zM959.99842 320.062089c0-59.775027-41.048144-109.977091-96.45212-124.058378a32.360228 32.360228 0 0 0 0.173397-4.002582V96.000564a31.970084 31.970084 0 1 0-63.940169 0V192.001129a32.291592 32.291592 0 0 0 0.299833 4.060381c-55.270316 14.160761-96.116162 64.301413-96.116163 124.000579s40.82056 109.836206 96.090876 124.000578a32.298816 32.298816 0 0 0-0.281771 3.99897V927.999436a31.970084 31.970084 0 1 0 63.940169 0V448.061637a32.381903 32.381903 0 0 0-0.166172-3.941171c55.407588-14.084899 96.452119-64.286963 96.45212-124.058377z m-82.746526 45.253022a63.997968 63.997968 0 1 1 18.748558-45.253022 63.578925 63.578925 0 0 1-18.748558 45.253022z"
            fill="" p-id="30415"></path>
        </svg> 阅读设置
      </li>
      <li @click="$router.push('/script')">
        <svg t="1641891075982" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="2152" width="200" height="200">
          <path
            d="M938.666667 42.666667a42.666667 42.666667 0 0 1 42.666666 42.666666v853.333334a42.666667 42.666667 0 0 1-42.666666 42.666666H85.333333a42.666667 42.666667 0 0 1-42.666666-42.666666V85.333333a42.666667 42.666667 0 0 1 42.666666-42.666666h853.333334z m-42.666667 298.666666H128v554.666667h768V341.333333zM382.890667 447.573333a21.333333 21.333333 0 0 1 30.122666-1.066666l31.232 29.098666a21.333333 21.333333 0 0 1 1.024 30.165334l-103.808 111.274666 103.808 111.36a21.333333 21.333333 0 0 1-1.024 30.122667l-31.232 29.098667a21.333333 21.333333 0 0 1-30.122666-1.024l-130.005334-139.392-14.464-13.482667a21.290667 21.290667 0 0 1-6.741333-16.64l0.128-3.626667a21.248 21.248 0 0 1 6.613333-13.056l14.421334-13.482666z m258.218666 0l130.005334 139.349334 14.464 13.482666c3.84 3.584 6.016 8.234667 6.613333 13.056l0.128 3.584a21.290667 21.290667 0 0 1-6.741333 16.682667l-14.506667 13.482667-129.962667 139.392a21.333333 21.333333 0 0 1-27.093333 3.413333l-3.029333-2.389333-31.232-29.098667a21.333333 21.333333 0 0 1-1.024-30.122667l103.765333-111.36-103.765333-111.274666a21.333333 21.333333 0 0 1 1.024-30.165334l31.232-29.098666a21.333333 21.333333 0 0 1 30.122666 1.066666zM896 128H128v128h768V128z"
            p-id="2153"></path>
        </svg>
        脚本管理
      </li>
      <li @click="$router.push('/netconfig')">
        <a-icon type="compass" /> 网络配置
      </li>
    </ul>
  </div>
</template>

<script>
const bg = chrome.extension.getBackgroundPage()
import chromeApi from '../../module/chrome'
import api from '../../module/api'
import { v4 as uuidv4 } from 'uuid';

export default {
  name: 'popup',
  data() {
    return {
      user: null
    }
  },
  created() {
    this.setUser()
  },
  methods: {
    openOptions(path = '') {
      chrome.tabs.create({ url: chrome.runtime.getURL('options.html') + '#/' + path, active: true, })
    },
    async readingMode() {
      try {
        let id = await this.getCode()
        let code = await chromeApi.getlocal(`script-${id}`)
        bg.toConnectSrcipt({ type: 'readingMode', code: code })
      } catch (error) {
        this.$message.error(error.message)
      }
    },
    async intoMode(type) {
      try {
        let id = await this.getCode()
        this.$router.push({
          name: 'tabs',
          params: {
            codeId: id
          }
        })
      } catch (error) {
        this.$message.error(error.message)
      }
    },
    async getCode() {
      try {
        let tab = await chromeApi.getCurrentTab()
        let list = await chromeApi.getlocal('srcipt_list')
        let host = tab.url.split('/')[2]
        list = JSON.parse(list)
        list = list ? list : []
        let match = list.find(ele => {
          let reg = new RegExp(ele.match);
          return ele.host.includes(host) && reg.test(tab.url)
        })
        if (!match) {
          let res = await api.getScript({ host: host })
          if (res.data.result) {
            let { codeMin, ...srcipt } = res.data.result
            srcipt.id = uuidv4()
            srcipt.source = 'konjac'
            list.push(srcipt)
            await chromeApi.savelocal({ 'srcipt_list': JSON.stringify(list) })
            await chromeApi.savelocal({ [`script-${srcipt.id}`]: codeMin })
            return Promise.resolve(srcipt.id)
          }
          return Promise.reject({ code: 1, message: '无匹配脚本' })
        }
        // let code = await chromeApi.getlocal(`script-${match.id}`)
        return Promise.resolve(match.id)
      } catch (error) {
        return Promise.reject(error)
      }
    },
    async setUser() {
      try {
        let user = await this.checkLogin()
        this.user = user
      } catch (error) {
      }
    },
    async checkLogin() {
      return new Promise((resolve, reject) => {
        chrome.storage.local.get(['konjac_user'], (result) => {
          if (result && result.konjac_user) { resolve(result.konjac_user) } else {
            reject()
          }
        })
      });
    },
  },
}
</script>

<style lang="less">
#home {
  margin-top: 10px;
  ul {
    padding: 0;
    list-style-type: none;
    li {
      cursor: pointer;
      margin-bottom: 10px;
      background-color: #fff;
      height: 45px;
      font-size: 16px;
      text-align: center;
      letter-spacing: 2px;
      line-height: 45px;
    }
  }
}
</style>